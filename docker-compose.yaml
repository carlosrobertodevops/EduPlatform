services:
  db:
    image: mysql:8.0
    container_name: grfcourses_db
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-grfcourses}
      MYSQL_USER: ${MYSQL_USER:-grfcourses}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-grfcourses}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
    ports:
      - "${DB_PORT:-3306}:3306"
    volumes:
      - grfcourses_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$$MYSQL_USER -p$$MYSQL_PASSWORD --silent"]
      interval: 5s
      timeout: 5s
      retries: 20

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: grfcourses_phpmyadmin
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
      PMA_USER: ${MYSQL_USER:-grfcourses}
      PMA_PASSWORD: ${MYSQL_PASSWORD:-grfcourses}
      PMA_ARBITRARY: 0
      UPLOAD_LIMIT: 256M
    ports:
      - "${PHPMYADMIN_PORT:-8080}:80"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: grfcourses_backend
    environment:
      DJANGO_DEBUG: ${DJANGO_DEBUG:-0}
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:-change-me}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:-localhost,127.0.0.1,backend}
      DJANGO_CSRF_TRUSTED_ORIGINS: ${DJANGO_CSRF_TRUSTED_ORIGINS:-http://localhost:3000}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000}

      DB_HOST: ${DB_HOST:-db}
      DB_NAME: ${DB_NAME:-grfcourses}
      DB_USER: ${DB_USER:-grfcourses}
      DB_PASSWORD: ${DB_PASSWORD:-grfcourses}
      DB_PORT_INTERNAL: ${DB_PORT_INTERNAL:-3306}

      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}

      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-2}
      GUNICORN_THREADS: ${GUNICORN_THREADS:-4}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-60}
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - .env
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      - grfcourses_backend_static:/app/staticfiles
      - grfcourses_backend_media:/app/media

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      NODE_ENV: ${NODE_ENV:-production}

      # Browser (client)
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}

      # Server (container-to-container)
      API_URL: ${API_URL:-http://backend:8000}

      # Auth.js / NextAuth
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      AUTH_URL: ${AUTH_URL:-http://localhost:3000}
      AUTH_TRUST_HOST: ${AUTH_TRUST_HOST:-true}

      # SECRET obrigat√≥rio (para sumir MissingSecret)
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change-me-super-secret-dev-key}
      AUTH_SECRET: ${AUTH_SECRET:-change-me-super-secret-dev-key}

      PORT: 3000
      HOSTNAME: 0.0.0.0
    depends_on:
      - backend
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "${FRONTEND_PORT:-3000}:3000"

volumes:
  db_data:
  grfcourses_db_data:
  grfcourses_backend_static:
  grfcourses_backend_media:
